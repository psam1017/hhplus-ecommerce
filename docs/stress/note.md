# 이커머스 부하테스트 보고서

## 목차

1. [부하 테스트의 의미](#부하-테스트의-의미)
2. [부하 테스트의 대상 선정 및 이유](#부하-테스트의-대상-선정-및-이유)
3. [부하 테스트 결과](#부하-테스트-결과)
4. [결론](#결론)

## 부하 테스트의 의미

<details>
  <summary>부하 테스트의 의미</summary>

부하 테스트는 소프트웨어를 실제 운영 환경에 배포하기 전에 시스템이 예상되는 트래픽과 부하를 효과적으로 처리할 수 있는지를 검증하는 과정입니다. 이를 통해 서버 배포 스펙을 적절히 정하고, 새로운 기능이나 이벤트가 발생할 때 안정적으로 서비스를 유지할 수 있는지를 사전에 확인할 수 있습니다.

부하 테스트의 주요 목적은 다음과 같습니다:

1. **시스템 안정성 확인**: 예상되는 트랜잭션 처리량(TPS)과 응답 시간을 측정하여 시스템이 정상적으로 동작하는지 평가합니다.
2. **성능 병목점 발견**: 동시성 이슈나 자원 부족 등 시스템의 취약한 부분을 사전에 찾아내어 개선할 수 있습니다.
3. **고가용성 보장**: 단일 장애 지점(SPOF)을 제거하고, 시스템이 장기간 동안 안정적으로 운영될 수 있도록 합니다.

부하 테스트는 다양한 형태로 수행되며, 일반적으로 다음과 같은 테스트를 포함합니다:

- **Load Test**: 예상 부하를 주어 시스템이 정상적으로 작동하는지 확인합니다.
- **Endurance Test**: 장기간 동안 지속적인 부하를 주어 메모리 누수나 성능 저하 같은 문제를 발견합니다.
- **Stress Test**: 점진적으로 부하를 증가시켜 시스템의 한계를 파악하고, 극한 상황에서의 동작을 평가합니다.
- **Peak Test**: 갑작스러운 높은 트래픽을 시뮬레이션하여 시스템이 급격한 부하에도 견딜 수 있는지를 테스트합니다.

부하 테스트를 통해 발견된 문제는 코드 최적화, 인프라 확장, 로직 개선 등을 통해 해결할 수 있습니다. 이를 통해 실제 서비스 운영 시 발생할 수 있는 장애를 사전에 방지하고, 사용자에게 안정적이고 원활한 서비스를 제공할 수 있습니다. 부하 테스트는 시스템의 신뢰성을 높이고, 비즈니스 목표를 달성하는 데 필수적인 과정입니다.

</details>

## 부하 테스트의 대상 선정 및 이유

<details>
  <summary>부하 테스트의 대상 선정 및 이유</summary>

여러 API 중에서 제가 선정한 부하 테스트를 수행할 API 는 총 4개입니다.

### 1. 상품 전체 목록 조회

- GET /api/items
- 상품 전체 목록을 페이지네이션으로 제공하며, 고객이 상품 조회 및 탐색을 가장 많이 사용하는 API 입니다.
- 해당 API 에는 캐시와 인덱스가 적용되어 있기에 반복적인 쿼리 발생을 줄여 높은 TPS 를 보여줄 것을 기대하고 있습니다.
- 30 명의 사용자가 90초 간 쉼 없이 요청했을 때, 1000 TPS 보장을 목표로 Load Test 를 수행합니다.

### 2. 상품 매출 상위 목록 조회

- GET /api/items/top
- 상품 매출 상위 목록을 제공하며, 사이트 랜딩 시 항상 조회할 API 이며 고객에게 유용한 정보를 제공하기에 GET /api/items 다음으로 가장 많이 사용될 API 입니다.
- 해당 API 에는 캐시와 인덱스가 적용되어 있기에 반복적인 쿼리 발생을 줄여 높은 TPS 를 보여줄 것을 기대하고 있습니다.
- 30 명의 사용자가 90초 간 쉼 없이 요청했을 때, 1000 TPS 보장을 목표로 Load Test 를 수행합니다.

### 3. 주문 생성

- POST /api/orders
- 분산락을 사용해 재고 개수의 정합성을 보장하고 있으며, 포인트 사용에서는 낙관적 락을 사용하여 정합성을 보장하고 있습니다.
- 한정 상품, 판매 대기 상품 등의 경우 일시적으로 주문이 몰릴 수 있기에 부하가 발생할 가능성이 있습니다.
- 동시에 500 명이 1번 요청했을 때 100건이 정합성을 지키며 동작하는지 확인하기 위한 Peak Test 를 수행합니다.

### 4. 포인트 충전

- POST /api/points/charge
- 자주 사용되거나 일시적으로 부하가 생길 가능성은 적지만, 낙관적 락을 사용한 동시성 제어를 하고 있기에 장애가 발생하지는 않는지 점검할 필요가 있습니다.
- 동시에 1명이 10번을 동시에 요청했을 때 낙관적 락에 의해 데이터 정합성이 지켜지는지 확인하기 위한 Load Test 를 수행합니다.

</details>

## 부하 테스트 결과

<details>
  <summary>부하 테스트 결과</summary>

### 장비 및 시스템 환경

- Operating System: Docker Desktop
- OSType: linux
- Architecture: x86_64
- CPUs: 12
- Total Memory: 6GiB

- 서비스 인프라 설정
  - MySQL
  - Redis
  - Kafka

- 테스트 도구
  - K6
  - Prometheus
  - Grafana

### 1. 상품 전체 목록 조회

![api-items-result](https://github.com/user-attachments/assets/5e027651-7ea5-472b-bc67-0672a296035a)

90초 동안의 약 84,000번의 요청이 처리되었으며 http_reqs 의 지표로 1,410 TPS 를 달성했음을 확인했습니다.

이와 같이 높은 TPS 를 바로 측정할 수 있었던 이유는 상품 전체 목록 조회 API 에 Redis Cache 를 적용하여 캐싱을 하고 있기 때문입니다.

이때 캐시는 상품의 기본 정보에만 적용되어 있으며, 재고 수량에는 적용되어 있지 않습니다. 이는 재고 수량이 수시로 변동할 수 있는 정보이기 때문입니다.

따라서 상품 기본 정보를 캐싱하고, 재고 수량은 인덱스를 활용하여 현재 서버가 1,000TPS 이상의 빠른 응답을 할 수 있음을 부하 테스트를 통해 확인했습니다.

### 2. 상품 매출 상위 목록 조회

![api-items-top-result](https://github.com/user-attachments/assets/5e587b32-036b-4da0-8852-5eaf4d6c8b43)

90초 동안 150,858번의 요청이 처리되었으며 http_reqs 의 지표로 2,514 TPS 를 달성했음을 확인했습니다.

상품 전체 목록과 같이 Redis Cache 및 Index 를 활용해 빠르게 응답됨을 확인했습니다.

#### 3. 주문 생성

![api-orders](https://github.com/user-attachments/assets/544e352b-9af6-499f-a254-b5a713e5e610)

(이미지 위쪽은 주문 실패 메시지가 이어져서 생략했습니다)

재고 개수를 100개를 두고, 1건씩 주문하는 요청을 500명의 사용자가 1번씩 요청했을 때의 결과입니다.

http_req_failed 를 통해 500건 중 100건이 정확하게 성공함을 확인할 수 있었고, 데이터베이스에서도 정확하게 100건의 주문이 생성됨을 확인했습니다.

### 4. 포인트 충전

![api-points-charge-result](https://github.com/user-attachments/assets/5712123d-8d52-48db-b32c-0f22b579eeed)

동시에 10번의 포인트 충전을 요청했을 때의 결과입니다.

http_req_failed 를 통해 10건 중 1건이 성공함을 확인할 수 있었고, 데이터베이스에서도 정확하게 1건의 포인트 충전이 생성됨을 확인했습니다. 

> 다만 테스트 결과에 따라 먼저 9건의 요청이 동시에 처리되고, 이후 1건의 요청이 처리되어 2건이 성공하는 등의 경우도 있었습니다.
> 
> 이러한 의도하지 않은 동작을 방지해야 한다면 포인트 충전의 단계를 주문과 결제로 나누고, 주문 생성 시에 주문키, 멱등성 키 등을 사용하여 한 건의 주문만 성공하도록 제어할 수 있습니다.

</details>

## 결론

<details>
  <summary>결론</summary>

항해플러스 9주의 과정을 거치면서 동시성 제어, 분산락, 캐싱, 카프카 등의 여러 기술들을 서버에 접목해왔습니다.

이번 마지막 주차에서는 해당 기술들이 제대로 작용되어 부하가 발생하거나, 동시에 요청이 발생했을 때 동시성 제어가 가능한지를 점검할 차례였습니다.

위와 같이 K6 를 사용한 가상 테스트를 통해 상품 전체 목록 조회, 상품 매출 상위 목록 조회, 주문 생성, 포인트 충전 API 가 각각의 목표치를 달성했음을 확인했습니다.

부하 테스트는 서비스의 안정성을 검증하고, 성능 병목점을 찾아내는 데 중요한 역할을 합니다. 이를 통해 서비스의 신뢰성을 높이고, 사용자에게 원활한 서비스를 제공해야 합니다.

</details>
