# 이커머스 성능지표 분석 및 장애대응 방안 문서

1. [성능지표 분석](#성능지표-분석)
2. [가상 장애 시나리오 및 대응방안](#가상-장애-시나리오-및-대응방안)

## 성능지표 분석

<details>
  <summary>성능지표 분석</summary>

프로젝트의 성능지표를 분석하기 위해 프로메테우스와 그라파나를 사용하여 메트릭 정보를 수집하고 이를 가시화했습니다.

### 프로메테우스란

애플리케이션에서 발생한 메트릭을 그 순간만 확인하는 것이 아니라 과거 이력까지 함께 확인하기 위해 메트릭을 보관하는 DB 입니다.

### 그라파나란

프로메테우스가 DB 라면 이 DB 의 데이터를 사용자에게 보기 편한 대시보드 UI 를 제공하는 도구입니다.

### 프로메테우스와 그라파나 설정

아래와 같이 docker compose 를 설정하고 프로메테우스와 그라파나를 같이 실행합니다.

```
services:
  # ...
  prometheus:
    container_name: prometheus
    image: prom/prometheus
    volumes:
      - ./prometheus/config/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./prometheus/data:/prometheus
    ports:
      - 9090:9090
    command:
      - --storage.tsdb.path=/prometheus
      - --config.file=/etc/prometheus/prometheus.yml
    networks:
      - ecommerce-network

  grafana:
    container_name: grafana
    image: grafana/grafana
    ports:
      - 3000:3000
    volumes:
      - ./grafana/data:/var/lib/grafana
    depends_on:
      prometheus:
        condition: service_started
    networks:
      - ecommerce-network
    # ...
```

프로메테우스가 Spring 애플리케이션의 데이터를 수집하도록 만들기 위한 설정 yml 을 아래와 같이 작성해줍니다.

특히 targets 에 `localhost` 가 아니라 `application` 과 같이 docker compose 의 컨테이너 이름을 사용해야 합니다.

```
# prometheus.yml

scrape_configs:
  - job_name: 'application'
    metrics_path: '/actuator/prometheus'
    scrape_interval: 5s
    static_configs:
      - targets: ['application:8080']
```

도커 컴포즈는 터미널에서 아래 명령어로 실행합니다.

```
docker compose up --build -d
```

### 그라파나의 데이터 소스 트러블 슈팅

![grafana-1](https://github.com/user-attachments/assets/547840f7-ef94-4b1b-a91a-3e59f0a9196c)

그라파나를 `localhost:3000` 에서 확인하면 프로메테우스와 연동해야 하는데, 이전에 했던 기억처럼 프로메테우스 URL 을 `localhost:9090` 로 지정하니 연결이 불가능했습니다.

같은 네트워크에서 실행시킨 그라파나와 프로메테우스는 host 에 컨테이너 이름을 명시해야 합니다.

### 대시보드 확인 및 분석 시도

그라파나에서 대시보드를 생성한 결과입니다. 대시보드는 직접 구성할 필요 없이 Import 를 할 수 있는데, 그 중에서 Spring Boot 2.1 System Monitor 를 사용했습니다.

![grafana-3](https://github.com/user-attachments/assets/4beb7e0f-b7b8-4b92-84ea-17deceb61b7f)

제가 생각한 것보다도 훨씬 많은 메트릭이 수집될 수 있었고, 그 중에서 처음 접하는 용어나, 용어는 알아도 이를 어떻게 활용할지 난감한 지표가 많았습니다.

부하 테스트를 진행할 때도 병목이나 장애라고 판단할 만한 지표가 눈에 띄지 않아 어떤 것들이 저에게 유용한 지표가 될 수 있을지 분석해봤습니다.

#### 로그 발생 횟수

![grafana-4](https://github.com/user-attachments/assets/c430f0f6-2caf-45ab-a18a-f806c3b00059)

현재 서버에서 필터의 동작을 확인하기 위해 각 필터마다 trace 로 예시로 기록되고 있습니다. 한편 비즈니스 예외나 접속 로그의 경우에는 info 레벨로 기록하고 있습니다.

정말 예상치 못한 심각한 장애의 경우 Error 가 발생하고 있는 상황에서 주문과 상품 조회 요청을 다수 보내봤을 때 의도한 대로 trace 와 info 레벨의 로그만 기록됨을 확인했습니다.

만약 error 로그가 발생한다면 해당 시간을 주의 깊게 볼 필요가 있고, 유용하게 사용할 수 있겠다는 생각이 들었습니다.

#### 커넥션 풀 상태

![grafana-5](https://github.com/user-attachments/assets/8d1af573-b6fa-481f-9a19-96451687501b)

다수의 요청이 발생하는 상황에서 커넥션이 대기(Pending) 상태에 놓이고 있음을 확인했습니다. 현재 요청 수준에서 커넥션 타임아웃이 생기지는 않았지만 혹시라도 타임아웃이 발생한다면 이미지의 왼쪽 상단과 같이 즉각 확인할 수 있기에, 이 또한 유용하게 사용할 수 있겠다는 생각이 들었습니다.

또한 커넥션 부족 상태가 생긴다면 커넥션 풀 사이즈를 조절하면서 적정 개수를 찾아가기에도 유용하게 사용할 수 있을 것입니다.

### 결론

프로메테우스와 그라파나를 사용하여 여러 지표들을 수집하고 가시화할 수 있었습니다.

특히 그라파나 대시보드에서는 리소스 사용률, 인스턴스 상태, 트래픽의 패턴을 포함하여, Spring 의 로그, 커넥션에 대한 정보까지 확인할 수 있습니다.

현재 부하 테스트를 진행하는 단계에서는 커넥션 타임아웃이나 에러 로그 등이 나타나진 않았지만 이러한 지표들과 알림 기능을 같이 활용한다면 즉각적으로 장애 대응을 할 수 있을 것입니다.

</details>

## 가상 장애 시나리오 및 대응방안

<details>
  <summary>가상 장애 시나리오 및 대응방안</summary>

### 가상 시나리오

현재 이커머스 서비스는 AWS Lightsail Instance 에 배포되어 있습니다.

Lightsail Instance 는 평소에 제한적인 CPU 성능을 가지고 있으며, 해당 제한을 초과하면 '버스트'라고 하는 CPU 크레딧을 소모합니다.

일반적으로 인스턴스의 CPU 사용률은 20% 미만을 유지하고 있으며, 개발자들은 부하 테스트를 통해서 CPU 사용량이 1시간 동안 20% 이상을 초과하게 되면 버스트를 모두 소진한다는 결론을 내렸습니다.

### 장애대응 시나리오

1. 프로메테우스와 그라파나를 사용한 모니터링 환경을 구축합니다.
2. 그라파나 알람(Grafana Alerting)을 사용하면 수집한 메트릭을 기반으로 알람을 사용할 수 있습니다.
    - CPU 사용률이 20% 이상을 초과하면, 지속시간에 따라 당직 개발자 / 담당 부서 / 상위 부서 등에게 이메일을 전송합니다.
    - 시간과 상관 없이 CPU 사용률이 100% 이상을 초과하면 즉시 당직 개발자에게 이메일을 전송합니다.

    (참고 이미지)
    ![grafana-6](https://github.com/user-attachments/assets/4fc303eb-3e08-4df4-a83b-9afe73421eca)
    
    ![grafana-10](https://github.com/user-attachments/assets/d29f509c-af89-49a8-9d50-106e4cde85e6)

3. 이메일을 수신한 담당자는 즉시 서버를 Scale Out 하고, 평소보다 요청 수가 많았던 원인을 파악합니다.
4. 원인을 파악한 담당자는 급한 안건이 아니라고 판단하면 보고서를 작성하고 회의에서 공유하고, 반면 급한 안건이라면 즉시 담당 부서에게 이를 공유하고 장애의 원인을 찾아 제거합니다.

### 장애 후속대응

1. 장애 보고서 작성
    - 장애 발생 시점, 경과 시간, 영향을 받은 서비스와 사용자 수를 포함한 상세 보고서를 작성합니다.
    - 장애 대응 과정에서 취한 조치와 결과를 명확히 기록합니다.

2. 데이터 검증 및 복구
    - 장애가 데이터에 영향을 미쳤는지 확인하고 필요한 경우 백업 데이터를 복구합니다.
    - 손상되거나 손실된 데이터가 있을 경우 복구 계획을 수립하고 실행합니다.

3. 재발 방지 조치
    - 장애 원인을 분석하고, 동일한 문제가 다시 발생하지 않도록 코드 수정, 아키텍처 개선, 또는 설정 변경 등을 시행합니다.
    - 장애 예방을 위한 자동화된 테스트 시나리오 추가와 모니터링 환경 개선을 검토합니다.

4. 피드백 및 공유
    - 장애 대응과 후속 조치 과정에서 얻은 교훈을 문서화하고, 관련 팀원들과 공유합니다.
    - 정기 회의나 리뷰 세션을 통해 대응 프로세스를 점검하고 개선할 기회를 모색합니다.

### 기타 대응방안

1. 사전 예방 조치
    - AWS 버스트 모니터링 강화 : 버스트 모니터링 소비량에 대한 대시보드를 추가로 구성하여, 소모 임계치를 실시간으로 파악할 수 있도록 합니다.
    - 스케일링 자동화 고려 : 지속적으로 장애가 발생한다면, AWS ELB 로 전환하고 트래픽 증가 시 자동으로 인스턴스를 추가하도록 Auto Scaling 을 구성합니다.

2. 리소스 최적화
    - CPU 사용량 분석 : CPU를 과도하게 사용하는 애플리케이션의 작업을 분석하고, 불필요한 작업을 최적화하거나 분산합니다.
    - 캐싱 강화 : 추가로 발견되는 병목이 존재한다면 해당 API 나 구간에서 캐싱을 추가합니다.

3. 교육 및 연습
    - 정기적으로 장애 대응 모의 훈련을 실시하여, 각 팀의 대응 역량을 강화합니다.
    - 장애 시나리오를 문서화하고, 새로운 팀원들에게 교육하여 긴급 상황에서의 대처 능력을 향상합니다.
    - 비상 연락 체계 구축 : 긴급 상황에서 필요한 연락망과 의사소통 체계를 명확히 정의하고 가상 시나리오에서 훈련을 수행합니다.

4. 비상 대책 마련
    - 예비 서버 준비 : 최악의 상황을 대비하여 예비 인스턴스를 미리 준비하거나, Blue-Green Deployment 전략을 적용합니다.

</details>
